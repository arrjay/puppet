worker_processes <%= @worker_processes -%>;

error_log <%= @error_log -%>;

events {
    worker_connections <%= @worker_connections -%>;
}

http {
<% if @top_includes
    @top_includes.each do |name| -%>
    include <%= name -%>;
<%  end
  end -%>
    default_type <%= @default_mimetype -%>;
<% if @sendfile == true -%>
    sendfile on;
<% end -%>
<%  @_sites.each do |site,keys| -%>
  server {
    listen <%= keys['port'] -%>;
    server_name <%= site -%>;
<% if keys['error_page'] -%>;
<% keys['error_page'].each do |codes,target| -%>
    error_page <%= codes -%> <%= target -%>;
<% end -%>
<% end -%>
<% keys['locations'].each do |location,subkeys| -%>
    location <%= location -%> {
      root <%= subkeys['root'] -%>;
<% if subkeys['index'] -%>
      index <%= subkeys['index'].join(" ") -%>;
<% end -%>
<% if subkeys['autoindex'] == true -%>
      autoindex on;
<% end -%>
    }
<% end -%>
  }
<%  end -%>
}

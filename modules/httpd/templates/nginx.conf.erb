user <%= @user -%>;
worker_processes <%= @worker_processes -%>;

error_log <%= @error_log -%>;
<% if @_pidfile -%>
pid <%= @_pidfile -%>;
<% end -%>

events {
    worker_connections <%= @worker_connections -%>;
}

http {
<% if @top_includes
  @top_includes.each do |name| -%>
  include <%= name -%>;
<%  end
  end -%>
  default_type <%= @default_mimetype -%>;
  log_format main '<%= @log_format -%>';
<% if @_log_file -%>
  access_log <%= @_log_file -%> main;
<% end -%>
<% if @sendfile == true -%>
  sendfile on;
<% end -%>
  keepalive_timeout <%= @keepalive_timeout -%>;
<%  @_sites.each do |site,keys| -%>
  server {
    listen <%= keys['port'] -%>;
    server_name <%= site -%>;
<% if keys['error_page'] -%>;
<% keys['error_page'].each do |codes,target| -%>
    error_page <%= codes -%> <%= target -%>;
<% end -%>
<% end -%>
<% keys['locations'].each do |location,subkeys| -%>
    location <%= location -%> {
      root <%= subkeys['root'] -%>;
<% if subkeys['index'] -%>
      index <%= subkeys['index'].join(" ") -%>;
<% end -%>
<% if subkeys['autoindex'] == true -%>
      autoindex on;
<% end -%>
    }
<% end -%>
  }
<%  end -%>
}

user <%= @user -%>;
worker_processes <%= @worker_processes -%>;

error_log <%= @error_log -%>;
<% if @_pidfile -%>
pid <%= @_pidfile -%>;
<% end -%>

events {
    worker_connections <%= @worker_connections -%>;
}

http {
<% if @top_includes
  @top_includes.each do |name| -%>
  include <%= name -%>;
<%  end
  end -%>
  default_type <%= @default_mimetype -%>;
  log_format main '<%= @log_format -%>';
<% if @_log_file -%>
  access_log <%= @_log_file -%> main;
<% end -%>
<% if @sendfile == true -%>
  sendfile on;
<% end -%>
<% if @tcp_nopush == true -%>
  tcp_nopush on;
<% end -%>
<% if @tcp_nodelay == true -%>
  tcp_nodelay on;
<% end -%>
  keepalive_timeout <%= @keepalive_timeout -%>;
<% if @types_hash_max_size != '' -%>
  types_hash_max_size <%= @types_hash_max_size -%>;
<% end -%>
<% if @gzip == true -%>
  gzip on;
<%   if @gzip_disable != '' -%>
  gzip_disable "<%= @gzip_disable -%>";
<%   end -%>
<% end -%>
<% if @_additional_http_opts -%>
<% @_additional_http_opts.each do |value| -%>
  <%= value %>
<% end -%>
<% end -%>
<%  @_sites.each do |site,keys| -%>
  server {
    listen <%= keys['port'] -%>;
    server_name <%= site -%>;
<% if keys['ssl_cert'] -%>
    ssl_certificate <%= keys['ssl_cert'] -%>;
    ssl_certificate_key <%= keys['ssl_key'] -%>;
<% if keys['ssl_ciphers'] -%>
    ssl_ciphers <%= keys['ssl_ciphers'] -%>;
<% else -%>
    ssl_ciphers <%= @ssl_opts['ciphers'] -%>;
<% end -%>
<% if keys['ssl_protocols'] -%>
    ssl_protocols <%= keys['ssl_protocols'] -%>;
<% else -%>
    ssl_protocols <%= @ssl_opts['protocols'] -%>;
<% end -%>
<% if defined? keys['ssl_prefer_server_ciphers'] -%>
<%   if keys['ssl_prefer_server_ciphers'] == true -%>
    ssl_prefer_server_ciphers on;
<%   else -%>
    ssl_prefer_server_ciphers off;
<%   end -%>
<% else -%>
<%   if ssl_opts['prefer_server_ciphers'] == true -%>
    ssl_prefer_server_ciphers on;
<%   else -%>
    ssl_prefer_server_ciphers off;
<%   end -%>
<% end -%>
<% if keys['ssl_session_cache'] -%>
    ssl_session_cache <%= keys['ssl_session_cache'] -%>;
<% else -%>
    ssl_session_cache <%= @ssl_opts['session_cache'] -%>;
<% end -%>
<% if keys['ssl_session_timeout'] -%>
    ssl_session_timeout <%= keys['ssl_session_timeout'] -%>;
<% else -%>
    ssl_session_timeout <%= @ssl_opts['session_timeout'] -%>;
<% end -%>
<% end -%>
<% if keys['error_page'] -%>
<% keys['error_page'].each do |codes,target| -%>
    error_page <%= codes -%> <%= target -%>;
<% end -%>
<% end -%>
<% if keys['access_log'] -%>
    access_log <%= keys['access_log'] -%>;
<% end -%>
<% if keys['error_log'] -%>
    error_log <%= keys['error_log'] -%>;
<% end -%>
<% if keys['additional_site_opts'] -%>
<% keys['additional_site_opts'].each do |value| -%>
    <%= value %>
<% end -%>
<% end -%>
<% if keys['locations'] -%>
<% keys['locations'].each do |location,subkeys| -%>
    location <%= location -%> {
      root <%= subkeys['root'] -%>;
<% if subkeys['index'] -%>
      index <%= subkeys['index'].join(" ") -%>;
<% end -%>
<% if subkeys['autoindex'] == true -%>
      autoindex on;
<% end -%>
    }
<% end -%>
<% end -%>
  }
<%  end -%>
}

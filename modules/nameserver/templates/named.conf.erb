<% params = scope.lookupvar('nameserver::params')
   nsgroup = scope.lookupvar('nameserver::nsgroup') -%>
options {
	listen-on-v6 { <%= @ipv6_listen -%>; };
	listen-on { <%= @ipv4_listen -%>; };
	directory "<%= @wrkdir -%>";
	pid-file "<%= @pidfile -%>";
	dump-file "<%= @dumpfile -%>";
	statistics-file "<%= @statsfile -%>";
<% if @miscopts -%>
<%   @miscopts.each do |line| -%>
	<%= line -%>;
<%   end -%>
<% end -%>
};
<% @views.each do |name,params| -%>
view "<%= name -%>" { match-clients { <%= params['services'].join("; ") -%>; };
<%   if params['recursion'] then -%>
	recursion yes;
<%   else -%>
	recursion no;
<%   end -%>
<%   if params['zones']
       params['zones'].each do |zone_name,zone_params| -%>
	zone "<%= zone_name -%>" {
		type <%= zone_params['type'] -%>;
<%       if zone_params['type'] == 'master' -%>
		file "<%= @_chrootref -%>/master/<%= zone_params['source'] -%>.db";
<%       elsif zone_params['type'] == 'slave'
           if zone_params['store'] -%>
		file "<%= @_chrootref -%>/slave/<%= zone_params['store'] -%>";
<%         else -%>
		file "<%= @_chrootref -%>/slave/<%= zone_name.gsub("/","_") -%>.db_<%= name -%>";
<%         end -%>
		masters { <%= zone_params['masters'].join("; ") -%>; };
<%       end -%>
	};
<%     end
     end -%>
<%   if params['includes']
       params['includes'].each do |name| -%>
	include "<%= @_chrootref -%>/<%= name -%>";
<%     end
     end -%>
};
<% end -%>

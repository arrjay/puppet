options {
	listen-on-v6 { <%= @_ipv6_listen -%>; };
	listen-on { <%= @_ipv4_listen -%>; };
	directory "<%= @wrkdir -%>";
	pid-file "<%= @pidfile -%>";
	dump-file "<%= @dumpfile -%>";
	statistics-file "<%= @statsfile -%>";
<% if @_miscopts -%>
<%   @_miscopts.each do |line| -%>
	<%= line -%>;
<%   end -%>
<% end -%>
};
<% @_views.each do |name,params| -%>
view "<%= name -%>" { match-clients { <%= params['services'].join("; ") -%>; };
<%   if params['recursion'] then -%>
	recursion yes;
<%   else -%>
	recursion no;
<%   end -%>
<%   if params['zones'].is_a?(Hash)
       params['zones'].each do |zone_name,zone_params| -%>
	zone "<%= zone_name -%>" {
		type <%= zone_params['type'] -%>;
<%       if zone_params['type'] == 'master' -%>
		file "<%= @_chrootref -%>/master/<%= zone_params['source'] -%>.db";
<%       elsif zone_params['type'] == 'slave'
           if zone_params['store'] -%>
		file "<%= @_chrootref -%>/slave/<%= zone_params['store'] -%>";
<%         else -%>
		file "<%= @_chrootref -%>/slave/<%= zone_name.gsub("/","_") -%>.db_<%= name -%>";
<%         end -%>
		masters { <%= zone_params['masters'].join("; ") -%>; };
<%       end -%>
	};
<%     end
     else	# assume array now - I'd rather get an error if we fucked up hieradata
       params['zones'].each do |zone_name| -%>
	zone "<%= zone_name -%>" {
		type <%= @_zone_params[zone_name]['type'] -%>;
<%       if @_zone_params[zone_name]['type'] == 'master' -%>
		file "<%= @_chrootref -%>/master/<%= @_zone_params[zone_name]['source'] -%>.db";
<%       elsif @_zone_params[zone_name]['type'] == 'slave' -%>
		file "<%= @_chrootref -%>/slave/<%= zone_name.gsub("/","_") -%>.db<%= name -%>";
		masters { <%= @_zone_params[zone_name]['masters'].join("; ") -%>; };
<%       end -%>
        }
<%     end -%>
<% end -%>
<%   if params['includes']
       params['includes'].each do |name| -%>
	include "<%= @_chrootref -%>/<%= name -%>";
<%     end
     end -%>
};
<% end -%>
